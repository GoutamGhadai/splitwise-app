<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareFare - Expense Splitting App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* slate-950 */
            color: #e2e8f0; /* slate-200 */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        #bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 2rem 2rem;
            z-index: -2;
            transition: background-image 0.3s ease;
        }
        #bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(56, 189, 248, 0.1), rgba(16, 185, 129, 0.1), transparent 40%);
            animation: rotate-gradient 25s linear infinite;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        @keyframes rotate-gradient {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.5); /* slate-800 with 50% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s ease-in-out;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 0 20px rgba(56, 189, 248, 0.2);
        }
        .glass-modal {
            background: rgba(15, 23, 42, 0.8); /* slate-900 with 80% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Light Theme */
        body.light {
            background-color: #f1f5f9; /* slate-100 */
            color: #1e293b; /* slate-800 */
        }
        .light #bg-pattern {
            background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.04) 1px, transparent 0);
        }
        .light #bg-gradient {
            opacity: 0;
        }
        .light .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 20px rgba(0,0,0,0.07);
        }
         .light .glass-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1), 0 0 10px rgba(56, 189, 248, 0.1);
        }
        .light .glass-modal {
            background: rgba(248, 250, 252, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .light ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .light ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }
        .light ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

        /* Light theme text overrides */
        .light .text-white { color: #0f172a; }
        .light h1, .light h2, .light h3, .light .font-bold { color: #0f172a; }
        .light .text-slate-200 { color: #334155; }
        .light .text-slate-300 { color: #475569; }
        .light .text-slate-400 { color: #64748b; }
        .light .text-slate-500 { color: #64748b; }

        /* Light theme component overrides */
        .light input, .light select {
            background-color: rgba(226, 232, 240, 0.5); /* slate-200/50 */
            border-color: #cbd5e1; /* slate-300 */
            color: #0f172a;
        }
        .light .bg-slate-900\/40 { background-color: rgba(226, 232, 240, 0.5); }
        .light .hover\:bg-slate-900\/80:hover { background-color: rgba(203, 213, 225, 0.7); }
        .light .bg-slate-700\/50 { background-color: rgba(226, 232, 240, 0.8); }
        .light .border-white\/10 { border-color: #e2e8f0; }
        .light .bg-black\/20 { background-color: rgba(255,255,255,0.2); }

        .light button.bg-slate-700 { background-color: #e2e8f0; color: #1e293b; }
        .light button.hover\:bg-slate-600:hover { background-color: #cbd5e1; }
        .light button.bg-slate-600 { background-color: #e2e8f0; color: #1e293b; }
        .light button.hover\:bg-slate-500:hover { background-color: #cbd5e1; }

        .light .text-slate-400.hover\:bg-white\/10:hover { background-color: rgba(0,0,0,0.05); }
        .light .text-slate-300.hover\:bg-white\/10:hover { background-color: rgba(0,0,0,0.05); }

        .light .bg-cyan-500\/20 { background-color: rgba(6, 182, 212, 0.1); }
        .light .text-cyan-400 { color: #0891b2; }

        .light .bg-emerald-500\/20 { background-color: rgba(16, 185, 129, 0.1); }
        .light .text-emerald-400 { color: #059669; }

        .light .bg-rose-500\/20 { background-color: rgba(244, 63, 94, 0.1); }
        .light .text-rose-400 { color: #e11d48; }

        .light .bg-amber-500\/20 { background-color: rgba(245, 158, 11, 0.1); }
        .light .text-amber-400 { color: #d97706; }
        
        .light .bg-blue-500\/20 { background-color: rgba(59, 130, 246, 0.1); }
        .light .text-blue-400 { color: #2563eb; }

        /* Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fadeInUp {
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">
    <div id="bg-pattern"></div>
    <div id="bg-gradient"></div>
    <div id="root"></div>

    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone for JSX compilation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // --- React Application Code ---
        const { useState, useEffect, useMemo } = React;

        // --- Helper Functions & Constants ---
        const APP_STORAGE_KEY = 'shareFareAppData_v2';
        const TOUR_STORAGE_KEY = 'shareFareTourCompleted_v1';
        const THEME_STORAGE_KEY = 'shareFareTheme_v1';
        const CATEGORIES = ['Food', 'Travel', 'Accommodation', 'Shopping', 'Activities', 'Other'];
        const CATEGORY_COLORS = {
            Food: '#f59e0b', // amber-500
            Travel: '#3b82f6', // blue-500
            Accommodation: '#8b5cf6', // violet-500
            Shopping: '#ec4899', // pink-500
            Activities: '#10b981', // emerald-500
            Other: '#64748b', // slate-500
        };
        const AVATAR_COLORS = ['#f87171', '#fb923c', '#facc15', '#4ade80', '#38bdf8', '#a78bfa', '#f472b6'];

        const generateId = () => `_${Math.random().toString(36).substr(2, 9)}`;

        const getInitials = (name = '') => {
            const parts = name.trim().split(' ');
            if (parts.length > 1 && parts[parts.length - 1]) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        };

        const generateAvatarColor = (name = '') => {
            const charCodeSum = name.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
            return AVATAR_COLORS[charCodeSum % AVATAR_COLORS.length];
        };

        const calculateSettlement = (trip) => {
            if (!trip || trip.guests.length < 2) {
                return { transactions: [] };
            }
            
            const { guests, expenses } = trip;
            const balances = guests.reduce((acc, guest) => ({ ...acc, [guest.id]: 0 }), {});

            expenses.forEach(expense => {
                const totalAmount = parseFloat(expense.amount);
                if (balances[expense.paidById] !== undefined) {
                    balances[expense.paidById] += totalAmount;
                }

                switch (expense.splitType) {
                    case 'amounts':
                        Object.entries(expense.splitDetails || {}).forEach(([guestId, amount]) => {
                            if (balances[guestId] !== undefined) {
                                balances[guestId] -= parseFloat(amount);
                            }
                        });
                        break;
                    case 'percentages':
                        Object.entries(expense.splitDetails || {}).forEach(([guestId, percentage]) => {
                            if (balances[guestId] !== undefined) {
                                const share = totalAmount * (parseFloat(percentage) / 100);
                                balances[guestId] -= share;
                            }
                        });
                        break;
                    default: // 'equally'
                        if (expense.splitWith.length > 0) {
                            const share = totalAmount / expense.splitWith.length;
                            expense.splitWith.forEach(guestId => {
                                if (balances[guestId] !== undefined) {
                                    balances[guestId] -= share;
                                }
                            });
                        }
                        break;
                }
            });

            const debtors = [];
            const creditors = [];
            Object.entries(balances).forEach(([guestId, balance]) => {
                if (balance < -0.01) debtors.push({ id: guestId, amount: -balance });
                else if (balance > 0.01) creditors.push({ id: guestId, amount: balance });
            });
            
            const transactions = [];
            let debtorIndex = 0, creditorIndex = 0;
            while (debtorIndex < debtors.length && creditorIndex < creditors.length) {
                const debtor = debtors[debtorIndex];
                const creditor = creditors[creditorIndex];
                const amountToSettle = Math.min(debtor.amount, creditor.amount);

                if (amountToSettle > 0.01) {
                    transactions.push({ from: debtor.id, to: creditor.id, amount: amountToSettle });
                }
                debtor.amount -= amountToSettle;
                creditor.amount -= amountToSettle;
                if (debtor.amount < 0.01) debtorIndex++;
                if (creditor.amount < 0.01) creditorIndex++;
            }

            return { transactions };
        };


        // --- SVG Icons ---
        const PlusIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
          </svg>
        );

        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
            </svg>
        );

        const EditIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                <path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" />
            </svg>
        );

        const UserGroupIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a3.004 3.004 0 015.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
        );

        const CurrencyDollarIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 12v4m0 4v1m-4-8h8m-4 4h4m-2-4a2.5 2.5 0 00-2.5 2.5V12a2.5 2.5 0 002.5 2.5m0-5a2.5 2.5 0 012.5 2.5V12a2.5 2.5 0 01-2.5 2.5m-5 0A4.5 4.5 0 0012 21a4.5 4.5 0 004.5-4.5m-9 0V7.5A4.5 4.5 0 0112 3a4.5 4.5 0 014.5 4.5v4.5m0 0v2.5" />
            </svg>
        );

        const BackArrowIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        );
        
        const CopyIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        );

        const ActivityIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const SuitcaseIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 21l-1.5-1.5m2.5-1.5-1.5-1.5M6.75 6.75h10.5M6.75 6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75z" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M9 3.75V2.25a2.25 2.25 0 012.25-2.25h1.5A2.25 2.25 0 0115 2.25v1.5" />
            </svg>
        );

        const ReceiptIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );

        const QuestionMarkIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const SunIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
            </svg>
        );

        const MoonIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
            </svg>
        );

        const ChartBarIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor" >
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
            </svg>
        );

        const WalletIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9A2.25 2.25 0 0018.75 6.75h-1.5a2.25 2.25 0 00-2.25 2.25v3.75M16.5 13.5h.008v.008h-.008v-.008Z" />
            </svg>
        );

        const ScaleIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0012 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52v1.664m-3.523 0c.25.041.5.082.75.122m-9 0c.25.041.5.082.75.122m-7.5 0v1.664m5.023 0c.25.041.5.082.75.122m-9 0c.25.041.5.082.75.122" />
            </svg>
        );

        const StarIcon = () => (
             <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.562.562 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.562.562 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5Z" />
            </svg>
        );

        // --- Main App Component ---
        function App() {
            // --- State Management ---
            const [trips, setTrips] = useState([]);
            const [activeTripId, setActiveTripId] = useState(null);
            const [expandedTripId, setExpandedTripId] = useState(null);
            const [theme, setTheme] = useState('dark');
            
            const [isGuestModalOpen, setGuestModalOpen] = useState(false);
            const [isExpenseModalOpen, setExpenseModalOpen] = useState(false);
            const [isTripModalOpen, setTripModalOpen] = useState(false);
            const [isTourOpen, setIsTourOpen] = useState(false);
            const [isUpdateExpensesModalOpen, setUpdateExpensesModalOpen] = useState(false);
            const [editingTrip, setEditingTrip] = useState(null);
            const [editingGuestId, setEditingGuestId] = useState(null);
            const [editingExpenseId, setEditingExpenseId] = useState(null);
            const [expandedSettlementIndex, setExpandedSettlementIndex] = useState(null);
            const [confirmAction, setConfirmAction] = useState(null);
            const [actionTargetId, setActionTargetId] = useState(null);
            const [copiedTripId, setCopiedTripId] = useState(null);

            // --- Theme Management ---
            useEffect(() => {
                const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
                const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
                setTheme(savedTheme || (prefersLight ? 'light' : 'dark'));
            }, []);

            useEffect(() => {
                document.body.className = '';
                document.body.classList.add(theme);
                localStorage.setItem(THEME_STORAGE_KEY, theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prevTheme => prevTheme === 'dark' ? 'light' : 'dark');
            };

            // --- Data Persistence using localStorage ---
            useEffect(() => {
                try {
                    const savedData = localStorage.getItem(APP_STORAGE_KEY);
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        const sanitizedTrips = (parsedData.trips || []).map(trip => ({
                            ...trip,
                            paidSettlements: trip.paidSettlements || {},
                            history: trip.history || [],
                        }));
                        setTrips(sanitizedTrips);
                    }
                } catch (error) {
                    console.error("Failed to load data from localStorage", error);
                }

                // Check if tour has been completed
                const tourCompleted = localStorage.getItem(TOUR_STORAGE_KEY);
                if (!tourCompleted) {
                    setIsTourOpen(true);
                }
            }, []);

            useEffect(() => {
                try {
                    // Only save the trips data, not the active trip state, for a fresh start.
                    const dataToSave = JSON.stringify({ trips });
                    localStorage.setItem(APP_STORAGE_KEY, dataToSave);
                } catch (error) {
                    console.error("Failed to save data to localStorage", error);
                }
            }, [trips]);

            const handleCloseTour = () => {
                setIsTourOpen(false);
                localStorage.setItem(TOUR_STORAGE_KEY, 'true');
            };
            
            // --- Handlers for Trips ---
            const handleTripAction = (tripData) => {
                if (editingTrip) { // Update existing trip
                     setTrips(prevTrips => prevTrips.map(trip => {
                        if (trip.id === editingTrip.id) {
                            const message = `The trip name was changed from "${trip.name}" to "${tripData.name}".`;
                            const newLog = {
                                id: generateId(),
                                message,
                                timestamp: new Date().toISOString()
                            };
                            return {
                                ...trip,
                                name: tripData.name,
                                date: tripData.date,
                                history: [newLog, ...(trip.history || [])]
                            };
                        }
                        return trip;
                    }));
                } else { // Create new trip
                    const newTrip = { id: generateId(), name: tripData.name, date: tripData.date, guests: [], expenses: [], paidSettlements: {}, history: [] };
                    const message = `Trip "${newTrip.name}" was created.`;
                    const newLog = { id: generateId(), message, timestamp: new Date().toISOString() };
                    newTrip.history.unshift(newLog);
                    
                    setTrips(prev => [...prev, newTrip]);
                    setActiveTripId(newTrip.id);
                }
                setTripModalOpen(false);
                setEditingTrip(null);
            };

            const handleEditTrip = (trip) => {
                setEditingTrip(trip);
                setTripModalOpen(true);
            };

            const deleteTrip = (tripId) => {
                setTrips(prev => prev.filter(t => t.id !== tripId));
            };
            
            const modifyActiveTrip = (updater, activityMessage) => {
                setTrips(prevTrips =>
                    prevTrips.map(t => {
                        if (t.id === activeTripId) {
                            const updatedTrip = updater(t);
                            if (activityMessage) {
                                const newLog = {
                                    id: generateId(),
                                    message: activityMessage,
                                    timestamp: new Date().toISOString()
                                };
                                updatedTrip.history = [newLog, ...(updatedTrip.history || [])];
                            }
                            return updatedTrip;
                        }
                        return t;
                    })
                );
            };
            
            const handleTogglePaid = (tripId, settlementKey) => {
                setTrips(prevTrips => prevTrips.map(trip => {
                    if (trip.id === tripId) {
                        const newPaidSettlements = { ...(trip.paidSettlements || {}) };
                        if (newPaidSettlements[settlementKey]) {
                            delete newPaidSettlements[settlementKey];
                        } else {
                            newPaidSettlements[settlementKey] = true;
                        }
                        return { ...trip, paidSettlements: newPaidSettlements };
                    }
                    return trip;
                }));
            };

            const fallbackCopyTextToClipboard = (text, tripId) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                textArea.style.opacity = '0';

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        setCopiedTripId(tripId);
                        setTimeout(() => setCopiedTripId(null), 2000);
                    }
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }

                document.body.removeChild(textArea);
            };
            
            const handleCopySummary = (trip) => {
                const { transactions } = calculateSettlement(trip);
                if (transactions.length === 0) return;

                const tripGuestMap = trip.guests.reduce((map, guest) => ({...map, [guest.id]: guest.name}), {});

                let summaryText = `Settlement Summary for "${trip.name}":\n`;
                transactions.forEach(t => {
                    const fromName = tripGuestMap[t.from];
                    const toName = tripGuestMap[t.to];
                    const amount = t.amount.toFixed(2);
                    summaryText += `- ${fromName} owes ${toName}: ₹${amount}\n`;
                });

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(summaryText).then(() => {
                        setCopiedTripId(trip.id);
                        setTimeout(() => setCopiedTripId(null), 2000);
                    }).catch(() => {
                        fallbackCopyTextToClipboard(summaryText, trip.id);
                    });
                } else {
                    fallbackCopyTextToClipboard(summaryText, trip.id);
                }
            };

             const _performAddGuest = (name, message) => {
                const newGuest = { id: generateId(), name };
                const logMessage = message || `${name} was added to the trip.`;
                modifyActiveTrip(trip => ({ ...trip, guests: [...trip.guests, newGuest] }), logMessage);
            };

            // --- Handlers for Guests & Expenses (now operate on the active trip) ---
            const addGuest = (name) => {
                if (name && activeTrip && !activeTrip.guests.some(g => g.name === name)) {
                    const potentialExpensesToUpdate = activeTrip.expenses.filter(exp =>
                        exp.splitType === 'equally'
                    );

                    if (potentialExpensesToUpdate.length > 0) {
                        setActionTargetId({ guestName: name, expensesToUpdate: potentialExpensesToUpdate });
                        setUpdateExpensesModalOpen(true);
                    } else {
                        _performAddGuest(name);
                    }
                }
            };

            const updateGuest = (id, newName) => {
                const oldGuest = activeTrip?.guests.find(g => g.id === id);
                if (!oldGuest) return;

                if (activeTrip.guests.some(g => g.name.toLowerCase() === newName.toLowerCase() && g.id !== id)) {
                    console.error("Guest name already exists");
                    // Optionally, set an error state to show in the modal
                    return;
                }

                const message = `${oldGuest.name}'s name was changed to ${newName}.`;
                modifyActiveTrip(trip => ({
                    ...trip,
                    guests: trip.guests.map(g => (g.id === id ? { ...g, name: newName } : g))
                }), message);
            };

            const handleOpenEditGuestModal = (guestId) => {
                setEditingGuestId(guestId);
                setGuestModalOpen(true);
            };
            
            const removeGuest = (id) => {
                const guestName = activeTrip?.guests.find(g => g.id === id)?.name;
                if (!guestName) return;

                const updater = trip => {
                    const updatedExpenses = trip.expenses
                        .filter(exp => exp.paidById !== id)
                        .map(exp => ({ ...exp, splitWith: exp.splitWith.filter(guestId => guestId !== id) }))
                        .filter(exp => exp.splitWith.length > 0);
                    return { ...trip, guests: trip.guests.filter(g => g.id !== id), expenses: updatedExpenses, paidSettlements: {} };
                };
                modifyActiveTrip(updater, `${guestName} was removed from the trip.`);
            };

            const addExpense = (expense) => {
                const payerName = activeTrip?.guests.find(g => g.id === expense.paidById)?.name || 'Someone';
                const message = `${payerName} added "${expense.description}" (₹${expense.amount.toFixed(2)}).`;
                modifyActiveTrip(trip => ({ ...trip, expenses: [...trip.expenses, { ...expense, id: generateId() }], paidSettlements: {} }), message);
            };
            
            const updateExpense = (id, updatedData) => {
                const message = `"${updatedData.description}" was edited.`;
                modifyActiveTrip(trip => ({ ...trip, expenses: trip.expenses.map(exp => (exp.id === id ? { ...exp, ...updatedData } : exp)), paidSettlements: {} }), message);
                setEditingExpenseId(null);
            };
            
            const removeExpense = (id) => {
                const expense = activeTrip?.expenses.find(e => e.id === id);
                if (!expense) return;
                const message = `"${expense.description}" was removed.`;
                modifyActiveTrip(trip => ({...trip, expenses: trip.expenses.filter(exp => exp.id !== id), paidSettlements: {} }), message);
            };

            const handleModalClose = () => {
                setConfirmAction(null);
                setActionTargetId(null);
            };

            const handleConfirmUpdateExpenses = (selectedExpenseIds) => {
                const { guestName } = actionTargetId;
                const newGuest = { id: generateId(), name: guestName };
                
                const updater = trip => {
                    const updatedGuests = [...trip.guests, newGuest];
                    const updatedExpenses = trip.expenses.map(exp => {
                        if (selectedExpenseIds.includes(exp.id)) {
                            return { ...exp, splitWith: [...exp.splitWith, newGuest.id] };
                        }
                        return exp;
                    });
                    return { ...trip, guests: updatedGuests, expenses: updatedExpenses, paidSettlements: {} };
                };

                let message;
                if (selectedExpenseIds.length > 0) {
                    message = `${guestName} was added and included in ${selectedExpenseIds.length} past expense(s).`;
                } else {
                    message = `${guestName} was added to the trip.`;
                }
                
                modifyActiveTrip(updater, message);
                setUpdateExpensesModalOpen(false);
                setActionTargetId(null);
            };

            const handleCloseUpdateExpensesModal = () => {
                const { guestName } = actionTargetId;
                _performAddGuest(guestName);
                setUpdateExpensesModalOpen(false);
                setActionTargetId(null);
            }

            const handleConfirm = () => {
                if (confirmAction === 'removeAllGuests') {
                    modifyActiveTrip(trip => ({ ...trip, guests: [], expenses: [], paidSettlements: {} }), 'All guests and expenses were removed.');
                } else if (confirmAction === 'removeAllExpenses') {
                    modifyActiveTrip(trip => ({ ...trip, expenses: [], paidSettlements: {} }), 'All expenses were removed.');
                } else if (confirmAction === 'deleteTrip') {
                    deleteTrip(actionTargetId);
                }
                setConfirmAction(null);
                setActionTargetId(null);
            };
            
            const handleOpenAddExpenseModal = () => {
                setEditingExpenseId(null);
                setExpenseModalOpen(true);
            };

            const handleOpenEditExpenseModal = (id) => {
                setEditingExpenseId(id);
                setExpenseModalOpen(true);
            };

            // --- Derived State & Calculations (Memoized for performance) ---
            const activeTrip = useMemo(() => trips.find(t => t.id === activeTripId), [trips, activeTripId]);

            const settlement = useMemo(() => calculateSettlement(activeTrip), [activeTrip]);

            const guestMap = useMemo(() => {
                if (!activeTrip) return {};
                return activeTrip.guests.reduce((map, guest) => ({...map, [guest.id]: guest.name}), {});
            }, [activeTrip]);

            const guestToEdit = useMemo(() => 
                activeTrip?.guests.find(g => g.id === editingGuestId), 
            [activeTrip, editingGuestId]);

            const spendingOverTime = useMemo(() => {
                if (!activeTrip || !activeTrip.expenses || activeTrip.expenses.length === 0) return null;

                const dailyTotals = activeTrip.expenses.reduce((acc, expense) => {
                    const date = expense.date; // YYYY-MM-DD
                    acc[date] = (acc[date] || 0) + parseFloat(expense.amount);
                    return acc;
                }, {});

                return Object.entries(dailyTotals)
                    .map(([date, amount]) => ({ date, amount }))
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
            }, [activeTrip]);

            const guestSummaries = useMemo(() => {
                if (!activeTrip) return {};
            
                const summaries = activeTrip.guests.reduce((acc, guest) => {
                    acc[guest.id] = { paid: 0, share: 0 };
                    return acc;
                }, {});
            
                activeTrip.expenses.forEach(expense => {
                    const totalAmount = parseFloat(expense.amount);
                    if (isNaN(totalAmount) || totalAmount <= 0) return;
            
                    if (summaries[expense.paidById]) {
                        summaries[expense.paidById].paid += totalAmount;
                    }
            
                    switch (expense.splitType) {
                        case 'amounts':
                            Object.entries(expense.splitDetails || {}).forEach(([guestId, amount]) => {
                                if (summaries[guestId]) {
                                    summaries[guestId].share += parseFloat(amount);
                                }
                            });
                            break;
                        case 'percentages':
                             Object.entries(expense.splitDetails || {}).forEach(([guestId, percentage]) => {
                                if (summaries[guestId]) {
                                    const share = totalAmount * (parseFloat(percentage) / 100);
                                    summaries[guestId].share += share;
                                }
                            });
                            break;
                        default: // 'equally'
                            if (expense.splitWith.length > 0) {
                                const share = totalAmount / expense.splitWith.length;
                                expense.splitWith.forEach(guestId => {
                                    if (summaries[guestId]) {
                                        summaries[guestId].share += share;
                                    }
                                });
                            }
                            break;
                    }
                });
            
                return summaries;
            }, [activeTrip]);

            const categorySummary = useMemo(() => {
                if (!activeTrip || activeTrip.expenses.length === 0) return null;

                const summary = activeTrip.expenses.reduce((acc, expense) => {
                    const category = expense.category || 'Other';
                    const amount = parseFloat(expense.amount);
                    if (!isNaN(amount)) {
                        acc[category] = (acc[category] || 0) + amount;
                    }
                    return acc;
                }, {});
                
                return Object.entries(summary)
                    .map(([name, amount]) => ({ name, amount }))
                    .sort((a, b) => b.amount - a.amount);

            }, [activeTrip]);

            let modalTitle = '';
            let modalBody = null;
            let modalConfirmText = '';
            let modalCancelText = 'Cancel';
            let isDestructive = false;

            if (confirmAction === 'deleteTrip') {
                modalTitle = 'Delete Trip?';
                modalBody = <p>Are you sure? This action will permanently delete this trip and all its data. This cannot be undone.</p>;
                modalConfirmText = 'Yes, Delete Trip';
                isDestructive = true;
            } else if (confirmAction === 'removeAllGuests') {
                modalTitle = "Remove All Guests?";
                modalBody = <p>Are you sure? This will remove all guests and permanently delete all associated expenses.</p>;
                modalConfirmText = "Yes, Remove All Guests";
                isDestructive = true;
            } else if (confirmAction === 'removeAllExpenses') {
                modalTitle = "Remove All Expenses?";
                modalBody = <p>Are you sure? This will permanently delete all expenses for this trip.</p>;
                modalConfirmText = "Yes, Remove All Expenses";
                isDestructive = true;
            }
            
            // --- Renders ---
            if (!activeTrip) {
                return (
                    <div className="min-h-screen w-full font-sans flex flex-col items-center justify-center p-4 relative">
                        <div className="absolute top-4 right-4 flex items-center gap-2">
                            <button onClick={toggleTheme} className="p-2 rounded-full text-slate-400 hover:bg-white/10 hover:text-white transition-all" title="Toggle Theme">
                                {theme === 'dark' ? <SunIcon /> : <MoonIcon />}
                            </button>
                            <button onClick={() => setIsTourOpen(true)} className="p-2 rounded-full text-slate-400 hover:bg-white/10 hover:text-white transition-all" title="Show Guide">
                                <QuestionMarkIcon />
                            </button>
                        </div>
                        <div className="w-full max-w-2xl text-center">
                            <h1 className="text-5xl font-bold text-white mb-3 animate-fadeInUp">ShareFare</h1>
                            <p className="text-lg text-slate-300 mb-10 animate-fadeInUp" style={{animationDelay: '0.2s'}}>Select a trip to manage or start a new one.</p>
                            <div className="animate-fadeInUp" style={{animationDelay: '0.4s'}}>
                                <button onClick={() => { setEditingTrip(null); setTripModalOpen(true); }} className="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-bold py-3 px-6 rounded-lg shadow-lg shadow-cyan-500/30 transition-all transform hover:-translate-y-1 hover:shadow-xl hover:shadow-cyan-500/50 active:scale-95 flex items-center justify-center gap-2 text-lg mx-auto">
                                    <PlusIcon />
                                    Add Trip/Event
                                </button>
                            </div>
                            <div className="mt-12 space-y-6">
                                {trips.length > 0 ? trips.map((trip, index) => {
                                    const { transactions } = calculateSettlement(trip);
                                    const tripGuestMap = trip.guests.reduce((map, guest) => ({...map, [guest.id]: guest.name}), {});

                                    return (
                                        <div key={trip.id} className="glass-card rounded-xl overflow-hidden" style={{animation: `fadeInUp 0.5s ${index * 0.1}s ease-out forwards`, opacity: 0}}>
                                            <div className="p-4 flex justify-between items-center cursor-pointer" onClick={() => setExpandedTripId(prevId => prevId === trip.id ? null : trip.id)}>
                                                <div>
                                                    <h2 className="font-bold text-xl text-left text-white">{trip.name}</h2>
                                                    <p className="text-sm text-slate-300 text-left">
                                                        On: {new Date(trip.date).toLocaleDateString()} | {trip.guests.length} guests, {trip.expenses.length} expenses
                                                    </p>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={(e) => { e.stopPropagation(); handleEditTrip(trip); }} className="text-slate-300 hover:text-cyan-400 p-2 rounded-full hover:bg-white/10 transition-all active:scale-90">
                                                        <EditIcon />
                                                    </button>
                                                    <button onClick={(e) => { e.stopPropagation(); setActionTargetId(trip.id); setConfirmAction('deleteTrip'); }} className="text-slate-300 hover:text-rose-400 p-2 rounded-full hover:bg-white/10 transition-all active:scale-90">
                                                        <TrashIcon />
                                                    </button>
                                                    <button onClick={(e) => { e.stopPropagation(); setActiveTripId(trip.id); }} className="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-semibold py-2 px-4 rounded-lg transition-all active:scale-95 shadow-lg shadow-cyan-500/30">
                                                        Open
                                                    </button>
                                                </div>
                                            </div>
                                            {expandedTripId === trip.id && (
                                                <div className="p-4 border-t border-white/10 bg-black/20 animate-fadeInUp">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h3 className="text-lg font-semibold text-left text-slate-300">Settlement Plan</h3>
                                                        {transactions.length > 0 && (
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); handleCopySummary(trip); }}
                                                                className="flex items-center gap-1.5 text-sm font-semibold py-1 px-2 rounded-md bg-slate-600 hover:bg-slate-500 transition-all active:scale-95 text-white"
                                                            >
                                                                {copiedTripId === trip.id ? 'Copied!' : <CopyIcon/>}
                                                                {copiedTripId === trip.id ? '' : 'Copy'}
                                                            </button>
                                                        )}
                                                    </div>
                                                    {transactions.length > 0 ? (
                                                        <ul className="space-y-2">
                                                            {transactions.map((t, index) => {
                                                                const settlementKey = `${t.from}-${t.to}-${t.amount.toFixed(2)}`;
                                                                const isPaid = trip.paidSettlements && trip.paidSettlements[settlementKey];
                                                                return (
                                                                    <li key={index} className="flex items-center justify-between bg-slate-700/50 p-3 rounded-lg gap-2">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={isPaid || false}
                                                                            onChange={() => handleTogglePaid(trip.id, settlementKey)}
                                                                            className="h-4 w-4 rounded bg-slate-600 border-slate-500 text-cyan-500 focus:ring-cyan-500"
                                                                        />
                                                                        <p className={`flex-1 truncate text-sm ${isPaid ? 'line-through text-slate-500' : ''}`}>
                                                                            <span className="font-bold text-cyan-400">{tripGuestMap[t.from]}</span>
                                                                            <span className="text-slate-300"> owes </span>
                                                                            <span className="font-bold text-emerald-400">{tripGuestMap[t.to]}</span>
                                                                        </p>
                                                                        <span className={`font-bold text-md text-white whitespace-nowrap ${isPaid ? 'line-through text-slate-500' : ''}`}>₹{t.amount.toFixed(2)}</span>
                                                                    </li>
                                                                );
                                                            })}
                                                        </ul>
                                                    ) : (
                                                        <p className="text-slate-300 text-left">All settled up!</p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                }) : (
                                    <div className="text-center pt-8 animate-fadeInUp" style={{animationDelay: '0.6s'}}>
                                        <div className="flex justify-center mb-4">
                                            <SuitcaseIcon />
                                        </div>
                                        <p className="text-slate-400">You haven't created any trips yet.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                        <TourGuide isOpen={isTourOpen} onClose={handleCloseTour} />
                        <TripModal isOpen={isTripModalOpen} onClose={() => setTripModalOpen(false)} onTripAction={handleTripAction} tripToEdit={editingTrip} />
                        <ConfirmationModal
                            isOpen={!!confirmAction}
                            onClose={handleModalClose}
                            onConfirm={handleConfirm}
                            title={modalTitle}
                            confirmButtonText={modalConfirmText}
                            cancelButtonText={modalCancelText}
                            isDestructive={isDestructive}
                        >
                            {modalBody}
                        </ConfirmationModal>
                    </div>
                );
            }


            return (
                <div className="min-h-screen font-sans">
                    <div className="container mx-auto max-w-5xl p-4">
                        
                        {/* Header */}
                        <header className="py-4 animate-fadeInUp">
                             <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3 min-w-0">
                                    <button onClick={() => setActiveTripId(null)} className="p-2 rounded-full text-slate-400 hover:bg-white/10 hover:text-white transition-all active:scale-90 flex-shrink-0">
                                       <BackArrowIcon />
                                   </button>
                                   <div className="min-w-0">
                                       <h1 className="text-2xl sm:text-3xl font-bold text-white tracking-tight truncate" title={activeTrip.name}>
                                           {activeTrip.name}
                                       </h1>
                                       <p className="text-sm text-slate-400">
                                            On: {new Date(activeTrip.date).toLocaleDateString()}
                                       </p>
                                   </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-sm font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500 hidden sm:block">
                                        ShareFare
                                    </span>
                                    <button onClick={toggleTheme} className="p-2 rounded-full text-slate-400 hover:bg-white/10 hover:text-white transition-all" title="Toggle Theme">
                                        {theme === 'dark' ? <SunIcon /> : <MoonIcon />}
                                    </button>
                                    <button onClick={() => setIsTourOpen(true)} className="p-2 rounded-full text-slate-400 hover:bg-white/10 hover:text-white transition-all" title="Show Guide">
                                        <QuestionMarkIcon />
                                    </button>
                                </div>
                             </div>
                        </header>

                        <Dashboard trip={activeTrip} guestSummaries={guestSummaries} />

                        <main className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* Left Column: Guests & Actions */}
                            <div className="lg:col-span-1 space-y-6 animate-fadeInUp" style={{animationDelay: '0.2s', opacity: 0}}>
                                <div className="glass-card p-5 rounded-2xl">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-2xl font-bold flex items-center gap-2 text-white">
                                            <UserGroupIcon />
                                            Trip Guests
                                        </h2>
                                        {activeTrip.guests.length > 0 && (
                                            <button onClick={() => setConfirmAction('removeAllGuests')} className="text-rose-400 hover:text-rose-300 p-1 rounded-full hover:bg-rose-500/20 font-semibold text-sm flex items-center gap-1 transition-all active:scale-90">
                                                <TrashIcon />
                                            </button>
                                        )}
                                    </div>
                                    <ul className="space-y-3">
                                        {activeTrip.guests.length > 0 ? activeTrip.guests.map((guest, index) => {
                                            const summary = guestSummaries[guest.id] || { paid: 0, share: 0 };
                                            return (
                                                <li key={guest.id} className="bg-slate-900/40 p-3 rounded-lg transition-all duration-200 hover:bg-slate-900/80 hover:shadow-lg animate-fadeInUp" style={{animationDelay: `${index * 0.1}s`, opacity: 0}}>
                                                    <div className="flex justify-between items-center">
                                                        <div className="flex items-center gap-3">
                                                            <Avatar name={guest.name} />
                                                            <span className="font-bold text-lg text-slate-200">{guest.name}</span>
                                                        </div>
                                                        <div className="flex items-center gap-1">
                                                            <button onClick={() => handleOpenEditGuestModal(guest.id)} className="text-slate-400 hover:text-cyan-400 p-1 rounded-full hover:bg-cyan-500/20 transition-all active:scale-90">
                                                                <EditIcon />
                                                            </button>
                                                            <button onClick={() => removeGuest(guest.id)} className="text-slate-400 hover:text-rose-400 p-1 rounded-full hover:bg-rose-500/20 flex-shrink-0 transition-all active:scale-90">
                                                                <TrashIcon />
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div className="flex justify-between items-center mt-2 text-sm pl-11">
                                                        <span className="font-semibold text-emerald-400">Paid: ₹{summary.paid.toFixed(2)}</span>
                                                        <span className="font-semibold text-amber-400">Share: ₹{summary.share.toFixed(2)}</span>
                                                    </div>
                                                </li>
                                            );
                                        }) : <p className="text-slate-300">Add some guests to get started!</p>}
                                    </ul>
                                    <button onClick={() => { setEditingGuestId(null); setGuestModalOpen(true); }} className="w-full mt-4 bg-gradient-to-r from-indigo-500 to-violet-500 hover:from-indigo-600 hover:to-violet-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-indigo-500/30 transition-all transform hover:-translate-y-1 hover:shadow-xl hover:shadow-indigo-500/40 active:scale-95 flex items-center justify-center gap-2">
                                        <PlusIcon />
                                        Add Guest
                                    </button>
                                </div>
                                {activeTrip.guests.length > 1 && (
                                    <QuickAddExpense 
                                        guests={activeTrip.guests}
                                        onQuickAdd={addExpense}
                                        onOpenDetailedModal={handleOpenAddExpenseModal}
                                    />
                                )}
                            </div>

                            {/* Right Column: Expenses & Summary */}
                            <div className="lg:col-span-2 space-y-8 animate-fadeInUp" style={{animationDelay: '0.4s', opacity: 0}}>

                                {/* Spending Summary */}
                                {categorySummary && (
                                    <div className="glass-card p-5 rounded-2xl">
                                        <h2 className="text-2xl font-bold mb-4 text-white">Spending by Category</h2>
                                        <div className="flex flex-col sm:flex-row items-center gap-4">
                                            <PieChart data={categorySummary} />
                                            <ChartLegend data={categorySummary} />
                                        </div>
                                    </div>
                                )}

                                {/* Expense List */}
                                <div className="glass-card p-5 rounded-2xl">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-2xl font-bold text-white">Expenses</h2>
                                        {activeTrip.expenses.length > 0 && (
                                            <button onClick={() => setConfirmAction('removeAllExpenses')} className="text-rose-400 hover:text-rose-300 p-1 rounded-full hover:bg-rose-500/20 font-semibold text-sm flex items-center gap-1 transition-all active:scale-90">
                                                <TrashIcon />
                                            </button>
                                        )}
                                    </div>
                                    <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                                        {activeTrip.expenses.length > 0 ? activeTrip.expenses.map((expense, index) => (
                                            <div key={expense.id} className="bg-slate-900/40 p-4 rounded-lg flex items-start justify-between transition-all duration-200 hover:bg-slate-900/80 hover:shadow-lg animate-fadeInUp" style={{animationDelay: `${index * 0.1}s`, opacity: 0}}>
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <span 
                                                            className="block w-3 h-3 rounded-full" 
                                                            style={{ backgroundColor: CATEGORY_COLORS[expense.category] || CATEGORY_COLORS['Other'] }}>
                                                        </span>
                                                        <p className="font-bold text-lg text-slate-200">{expense.description}</p>
                                                    </div>
                                                    <p className="text-sm text-slate-300 pl-5">
                                                        Paid by <span className="font-semibold text-slate-200">{guestMap[expense.paidById]}</span> on {new Date(expense.date).toLocaleDateString()}
                                                    </p>
                                                    <p className="text-sm text-slate-400 mt-1 pl-5">
                                                        {expense.splitType === 'equally' ? `Split equally with: ${expense.splitWith.map(id => guestMap[id]).join(', ')}` : `Split unequally`}
                                                    </p>
                                                </div>
                                                <div className="text-right flex-shrink-0 ml-4">
                                                    <p className="text-xl font-bold text-emerald-400">₹{parseFloat(expense.amount).toFixed(2)}</p>
                                                     <div className="flex items-center justify-end gap-2 mt-1">
                                                        <button onClick={() => handleOpenEditExpenseModal(expense.id)} className="text-slate-400 hover:text-cyan-400 p-1 rounded-full hover:bg-cyan-500/20 transition-all active:scale-90">
                                                            <EditIcon />
                                                        </button>
                                                        <button onClick={() => removeExpense(expense.id)} className="text-slate-400 hover:text-rose-400 p-1 rounded-full hover:bg-rose-500/20 transition-all active:scale-90">
                                                            <TrashIcon />
                                                        </button>
                                                     </div>
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="text-center py-10">
                                                <div className="flex justify-center mb-4">
                                                    <ReceiptIcon />
                                                </div>
                                                <p className="text-slate-400">No expenses added yet.</p>
                                                <p className="text-sm text-slate-500 mt-2">Add the first expense to see it here.</p>
                                            </div>
                                        )}
                                        </div>
                                </div>

                                {/* Settlement Summary */}
                                {settlement.transactions.length > 0 && (
                                    <div className="glass-card p-5 rounded-2xl">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold text-white">How to Settle Up</h2>
                                            <button
                                                onClick={() => handleCopySummary(activeTrip)}
                                                className="flex items-center gap-1.5 text-sm font-semibold py-1 px-2 rounded-md bg-slate-600 hover:bg-slate-500 transition-all active:scale-95 text-white"
                                            >
                                                {copiedTripId === activeTrip.id ? 'Copied!' : <CopyIcon/>}
                                                {copiedTripId === activeTrip.id ? '' : 'Copy Summary'}
                                            </button>
                                        </div>
                                        <ul className="space-y-3">
                                            {settlement.transactions.map((t, index) => {
                                                const settlementKey = `${t.from}-${t.to}-${t.amount.toFixed(2)}`;
                                                const isPaid = activeTrip.paidSettlements && activeTrip.paidSettlements[settlementKey];
                                                return (
                                                    <li 
                                                        key={index} 
                                                        className="flex items-center justify-between bg-slate-900/40 p-4 rounded-lg gap-2"
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={isPaid || false}
                                                            onChange={() => handleTogglePaid(activeTrip.id, settlementKey)}
                                                            className="h-5 w-5 rounded bg-slate-600 border-slate-500 text-cyan-500 focus:ring-cyan-500 flex-shrink-0"
                                                        />
                                                        <div className="flex-1 min-w-0 flex items-center gap-2 cursor-pointer lg:cursor-default" onClick={() => setExpandedSettlementIndex(expandedSettlementIndex === index ? null : index)}>
                                                            <Avatar name={guestMap[t.from]} size="sm" />
                                                            <p className={`${expandedSettlementIndex === index ? 'whitespace-normal' : 'truncate'} text-sm sm:text-base ${isPaid ? 'line-through text-slate-500' : 'text-slate-300'}`}>
                                                                <span className="font-bold text-cyan-400">{guestMap[t.from]}</span>
                                                                <span className="text-slate-300"> owes </span>
                                                                <span className="font-bold text-emerald-400">{guestMap[t.to]}</span>
                                                            </p>
                                                            <Avatar name={guestMap[t.to]} size="sm" />
                                                        </div>
                                                        <span className={`font-bold text-lg sm:text-xl text-white whitespace-nowrap ${isPaid ? 'line-through text-slate-500' : ''}`}>₹{t.amount.toFixed(2)}</span>
                                                    </li>
                                                );
                                            })}
                                        </ul>
                                    </div>
                                )}
                                 {/* Activity Feed */}
                                {activeTrip.history && activeTrip.history.length > 0 && (
                                    <div className="glass-card p-5 rounded-2xl">
                                        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2 text-white">
                                            <ActivityIcon />
                                            Activity History
                                        </h2>
                                        <ActivityFeed history={activeTrip.history} />
                                    </div>
                                )}
                                {spendingOverTime && spendingOverTime.length > 1 && (
                                    <div className="animate-fadeInUp" style={{animationDelay: '0.6s', opacity: 0}}>
                                        <SpendingChart data={spendingOverTime} />
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>
                    
                    {/* Modals */}
                    <TourGuide isOpen={isTourOpen} onClose={handleCloseTour} />
                    <UpdatePastExpensesModal
                        isOpen={isUpdateExpensesModalOpen}
                        onClose={handleCloseUpdateExpensesModal}
                        onConfirm={handleConfirmUpdateExpenses}
                        guestName={actionTargetId?.guestName}
                        expensesToUpdate={actionTargetId?.expensesToUpdate || []}
                    />
                    <GuestModal 
                        isOpen={isGuestModalOpen} 
                        onClose={() => { setGuestModalOpen(false); setEditingGuestId(null); }} 
                        onAddGuest={addGuest} 
                        onUpdateGuest={updateGuest}
                        guestToEdit={guestToEdit}
                        existingGuests={activeTrip?.guests || []}
                    />
                    <ExpenseModal 
                        isOpen={isExpenseModalOpen} 
                        onClose={() => { setExpenseModalOpen(false); setEditingExpenseId(null); }} 
                        onAddExpense={addExpense} 
                        onUpdateExpense={updateExpense}
                        guests={activeTrip.guests}
                        expenseToEdit={activeTrip.expenses.find(exp => exp.id === editingExpenseId)}
                    />
                     <ConfirmationModal
                        isOpen={!!confirmAction}
                        onClose={handleModalClose}
                        onConfirm={handleConfirm}
                        title={modalTitle}
                        confirmButtonText={modalConfirmText}
                        cancelButtonText={modalCancelText}
                        isDestructive={isDestructive}
                    >
                        {modalBody}
                    </ConfirmationModal>
                </div>
            );
        }

        // --- Child Components ---

        function UpdatePastExpensesModal({ isOpen, onClose, onConfirm, guestName, expensesToUpdate }) {
            const [selectedIds, setSelectedIds] = useState([]);
            const [isAnimating, setIsAnimating] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    // Default to all selected
                    setSelectedIds(expensesToUpdate.map(e => e.id));
                    requestAnimationFrame(() => setIsAnimating(true));
                } else {
                    setIsAnimating(false);
                }
            }, [isOpen, expensesToUpdate]);

            const handleClose = () => {
                setIsAnimating(false);
                setTimeout(onClose, 300);
            };

            const handleConfirm = () => {
                onConfirm(selectedIds);
            };

            const toggleAll = () => {
                if (selectedIds.length === expensesToUpdate.length) {
                    setSelectedIds([]);
                } else {
                    setSelectedIds(expensesToUpdate.map(e => e.id));
                }
            };

            const toggleOne = (id) => {
                setSelectedIds(prev =>
                    prev.includes(id) ? prev.filter(pId => pId !== id) : [...prev, id]
                );
            };

            if (!isOpen && !isAnimating) return null;

            return (
                <div
                    className={`fixed inset-0 z-50 flex items-center justify-center p-4 bg-black transition-opacity duration-300 ${isAnimating ? 'bg-opacity-70' : 'bg-opacity-0'}`}
                    onClick={handleClose}
                >
                    <div
                        className={`glass-modal rounded-xl shadow-xl w-full max-w-lg p-6 transform transition-all duration-300 ${isAnimating ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0'}`}
                        onClick={e => e.stopPropagation()}
                    >
                        <h2 className="text-2xl font-bold mb-2 text-white">Update Past Expenses?</h2>
                        <p className="text-slate-300 mb-4">
                            <strong>{guestName}</strong> can be added to past equally-split expenses. Select which ones to include them in.
                        </p>

                        <div className="space-y-2 max-h-60 overflow-y-auto pr-2 border-y border-slate-700 py-3">
                            <div className="flex items-center gap-3 p-2">
                                <input
                                    type="checkbox"
                                    checked={selectedIds.length === expensesToUpdate.length && expensesToUpdate.length > 0}
                                    onChange={toggleAll}
                                    className="h-5 w-5 rounded bg-slate-600 border-slate-500 text-cyan-500 focus:ring-cyan-500"
                                />
                                <label className="font-bold text-white">Select All</label>
                            </div>
                            {expensesToUpdate.map(expense => (
                                <div key={expense.id} className={`flex items-center gap-3 p-2 rounded-md transition-colors ${selectedIds.includes(expense.id) ? 'bg-cyan-500/20' : 'bg-slate-700/30'}`}>
                                     <input
                                        type="checkbox"
                                        checked={selectedIds.includes(expense.id)}
                                        onChange={() => toggleOne(expense.id)}
                                        className="h-5 w-5 rounded bg-slate-600 border-slate-500 text-cyan-500 focus:ring-cyan-500"
                                    />
                                    <div className="flex-grow">
                                        <p className="font-semibold text-slate-200">{expense.description}</p>
                                        <p className="text-sm text-slate-400">₹{expense.amount.toFixed(2)} on {new Date(expense.date).toLocaleDateString()}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="flex justify-end gap-4 mt-6">
                            <button type="button" onClick={handleClose} className="py-2 px-4 bg-slate-700 hover:bg-slate-600 rounded-md font-semibold transition-all active:scale-95 text-white">
                                Just Add Guest
                            </button>
                            <button type="button" onClick={handleConfirm} className="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md font-semibold transition-all active:scale-95 shadow-lg shadow-indigo-500/30">
                                Update {selectedIds.length > 0 ? selectedIds.length : ''} Expense(s)
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function Dashboard({ trip, guestSummaries }) {
            const dashboardStats = useMemo(() => {
                if (!trip || !trip.guests || trip.guests.length === 0) {
                    return {
                        totalCost: 0,
                        yourBalance: 0,
                        topSpender: { name: 'N/A', amount: 0 }
                    };
                }

                // 1. Total Trip Cost
                const totalCost = trip.expenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);

                // 2. "Your" Balance (assuming "You" are the first guest)
                const you = trip.guests[0];
                const yourSummary = guestSummaries[you.id] || { paid: 0, share: 0 };
                const yourBalance = yourSummary.paid - yourSummary.share;

                // 3. Top Spender
                let topSpender = { name: 'N/A', amount: 0 };
                if (trip.guests.length > 0) {
                    topSpender = trip.guests.reduce((currentTop, guest) => {
                        const guestPaid = guestSummaries[guest.id]?.paid || 0;
                        if (guestPaid > currentTop.amount) {
                            return { name: guest.name, amount: guestPaid };
                        }
                        return currentTop;
                    }, { name: trip.guests[0].name, amount: guestSummaries[trip.guests[0].id]?.paid || 0 });
                }

                return { totalCost, yourBalance, topSpender };
            }, [trip, guestSummaries]);

            const balanceColor = dashboardStats.yourBalance >= 0 ? 'text-emerald-400' : 'text-rose-400';
            const balanceText = dashboardStats.yourBalance >= 0 
                ? `You are owed ₹${dashboardStats.yourBalance.toFixed(2)}` 
                : `You owe ₹${(-dashboardStats.yourBalance).toFixed(2)}`;

            return (
                <div className="mb-8 animate-fadeInUp" style={{animationDelay: '0.1s'}}>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {/* Total Cost */}
                        <div className="glass-card p-5 rounded-2xl flex items-center gap-4">
                            <div className="bg-blue-500/20 p-3 rounded-lg text-blue-400">
                                <WalletIcon />
                            </div>
                            <div>
                                <p className="text-sm text-slate-400 font-medium">Total Trip Cost</p>
                                <p className="text-2xl font-bold text-white">₹{dashboardStats.totalCost.toFixed(2)}</p>
                            </div>
                        </div>

                        {/* Your Balance */}
                        <div className="glass-card p-5 rounded-2xl flex items-center gap-4">
                            <div className={`${dashboardStats.yourBalance >= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'} p-3 rounded-lg`}>
                                <ScaleIcon />
                            </div>
                            <div>
                                <p className="text-sm text-slate-400 font-medium">Your Balance (as {trip?.guests[0]?.name})</p>
                                <p className={`text-xl font-bold ${balanceColor}`}>
                                    {balanceText}
                                </p>
                            </div>
                        </div>

                        {/* Top Spender */}
                        <div className="glass-card p-5 rounded-2xl flex items-center gap-4">
                            <div className="bg-amber-500/20 p-3 rounded-lg text-amber-400">
                                <StarIcon />
                            </div>
                            <div>
                                <p className="text-sm text-slate-400 font-medium">Top Spender</p>
                                <p className="text-2xl font-bold text-white truncate">{dashboardStats.topSpender.name}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function SpendingChart({ data }) {
            const maxAmount = useMemo(() => Math.max(...data.map(d => d.amount)), [data]);

            const formatDate = (dateString) => {
                const date = new Date(dateString);
                // To account for timezone issues where new Date() might go to the previous day
                date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            };

            return (
                <div className="glass-card p-5 rounded-2xl">
                    <h2 className="text-2xl font-bold mb-4 flex items-center gap-2 text-white">
                        <ChartBarIcon />
                        Spending Over Time
                    </h2>
                    <div className="h-56 flex flex-col">
                        <div className="flex-grow flex items-end gap-2 border-b border-slate-700 pb-2">
                            {data.map((item, index) => (
                                <div key={index} className="relative flex-1 h-full flex items-end justify-center group">
                                    <div 
                                        className="w-3/4 bg-cyan-500 rounded-t-md hover:bg-cyan-400 transition-colors"
                                        style={{ height: `${(item.amount / maxAmount) * 100}%` }}
                                    >
                                    </div>
                                    <div className="absolute -top-8 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-slate-900/80 text-white text-xs font-bold py-1 px-2 rounded-md whitespace-nowrap">
                                        ₹{item.amount.toFixed(2)}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="flex items-start gap-2 pt-2 text-xs text-slate-400">
                             {data.map((item, index) => (
                                <div key={index} className="flex-1 text-center">
                                    {formatDate(item.date)}
                                </div>
                             ))}
                        </div>
                    </div>
                </div>
            );
        }

        function TourGuide({ isOpen, onClose }) {
            const [currentStep, setCurrentStep] = useState(0);
            const [isAnimating, setIsAnimating] = useState(false);

            const tourSteps = [
                {
                    title: "Welcome to ShareFare!",
                    content: "This quick guide will walk you through the main features. Let's get started with splitting expenses effortlessly."
                },
                {
                    title: "Step 1: Create a Trip",
                    content: "Everything starts with a trip or event. Click the 'Add Trip/Event' button on the main screen to create a new group for your expenses. Give it a name and a date."
                },
                {
                    title: "Step 2: Add Your Guests",
                    content: "Once you open a trip, you can start adding the people you'll be sharing costs with. Just click 'Add Guest' and type in their name."
                },
                {
                    title: "Step 3: Log Your Expenses",
                    content: "Use the 'Quick Add' form for simple, equally-split expenses. For more complex splits (by amount, percentage, or with specific people), click 'More Options...' to open the detailed expense form."
                },
                {
                    title: "Step 4: Settle Up Automatically",
                    content: "ShareFare does the hard work for you! The 'How to Settle Up' section shows the simplest way for everyone to pay each other back. No more complicated math!"
                },
                {
                    title: "You're All Set!",
                    content: "That's it! You're ready to manage your group expenses like a pro. You can revisit this guide anytime by clicking the question mark icon."
                }
            ];

            useEffect(() => {
                if (isOpen) {
                    setCurrentStep(0);
                    requestAnimationFrame(() => setIsAnimating(true));
                } else {
                    setIsAnimating(false);
                }
            }, [isOpen]);

            const handleClose = () => {
                setIsAnimating(false);
                setTimeout(onClose, 300);
            };

            const handleNext = () => {
                if (currentStep < tourSteps.length - 1) {
                    setCurrentStep(currentStep + 1);
                } else {
                    handleClose();
                }
            };

            const handlePrev = () => {
                if (currentStep > 0) {
                    setCurrentStep(currentStep - 1);
                }
            };
            
            if (!isOpen && !isAnimating) return null;

            const step = tourSteps[currentStep];

            return (
                 <div 
                    className={`fixed inset-0 z-50 flex items-center justify-center p-4 bg-black transition-opacity duration-300 ${isAnimating ? 'bg-opacity-70' : 'bg-opacity-0'}`}
                    onClick={handleClose}
                >
                    <div 
                        className={`glass-modal rounded-xl shadow-xl w-full max-w-md p-6 transform transition-all duration-300 ${isAnimating ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0'}`}
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="text-center">
                            <h2 className="text-2xl font-bold mb-2 text-white">{step.title}</h2>
                            <p className="text-slate-300 mb-6">{step.content}</p>
                        </div>

                        <div className="flex justify-center items-center gap-2 mb-6">
                            {tourSteps.map((_, index) => (
                                <div key={index} className={`w-2 h-2 rounded-full transition-all ${index === currentStep ? 'bg-cyan-400 scale-125' : 'bg-slate-600'}`}></div>
                            ))}
                        </div>
                        
                        <div className="flex justify-between items-center">
                             <button 
                                onClick={handlePrev} 
                                className={`py-2 px-5 bg-slate-700 hover:bg-slate-600 text-white rounded-md font-semibold transition-all active:scale-95 ${currentStep === 0 ? 'opacity-50 cursor-not-allowed' : ''}`}
                                disabled={currentStep === 0}
                            >
                                Prev
                            </button>
                             <button 
                                onClick={handleNext} 
                                className="py-2 px-5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md font-semibold transition-all active:scale-95 shadow-lg shadow-indigo-500/30"
                            >
                                {currentStep === tourSteps.length - 1 ? 'Finish' : 'Next'}
                            </button>
                        </div>
                    </div>
                </div>
            )
        }

        function QuickAddExpense({ guests, onQuickAdd, onOpenDetailedModal }) {
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [paidById, setPaidById] = useState(guests.length > 0 ? guests[0].id : '');
            const [error, setError] = useState('');

            useEffect(() => {
                if (guests.length > 0) {
                    setPaidById(guests[0].id);
                }
            }, [guests]);

            const handleQuickAdd = () => {
                const numAmount = parseFloat(amount);
                if (!description.trim()) { 
                    setError('Description is required.'); 
                    return; 
                }
                if (isNaN(numAmount) || numAmount <= 0) { 
                    setError('A valid amount is required.'); 
                    return; 
                }

                const expenseData = {
                    description: description.trim(),
                    amount: numAmount,
                    date: new Date().toISOString().split('T')[0],
                    paidById,
                    splitWith: guests.map(g => g.id),
                    category: 'Other',
                    splitType: 'equally',
                    splitDetails: {},
                };

                onQuickAdd(expenseData);
                // Reset form
                setDescription('');
                setAmount('');
                setError('');
            };

            return (
                <div className="glass-card p-5 rounded-2xl">
                    <h3 className="text-xl font-bold text-white mb-3">Quick Add Expense</h3>
                    <div className="space-y-3">
                        <input
                            type="text"
                            value={description}
                            onChange={e => setDescription(e.target.value)}
                            placeholder="Expense Description"
                            className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                        />
                        <div className="grid grid-cols-2 gap-2">
                             <input
                                type="number"
                                value={amount}
                                onChange={e => setAmount(e.target.value)}
                                placeholder="Amount (₹)"
                                className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                            />
                             <select value={paidById} onChange={e => setPaidById(e.target.value)} className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                                {guests.map(g => <option key={g.id} value={g.id}>{g.name} paid</option>)}
                            </select>
                        </div>
                        {error && <p className="text-xs text-rose-400">{error}</p>}
                        <div className="flex gap-2 pt-2">
                             <button onClick={handleQuickAdd} className="w-full bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-400 hover:to-green-400 text-white font-bold py-2 px-3 rounded-lg shadow-lg shadow-emerald-500/30 transition-all transform hover:-translate-y-1 hover:shadow-xl hover:shadow-emerald-500/40 active:scale-95 flex items-center justify-center gap-2 text-sm">
                                Add
                            </button>
                             <button onClick={onOpenDetailedModal} className="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-all transform hover:-translate-y-1 hover:shadow-lg active:scale-95 flex items-center justify-center gap-2 text-sm">
                                More Options...
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function Avatar({ name, size = 'md' }) {
            const sizeClasses = {
                sm: 'w-6 h-6 text-xs',
                md: 'w-8 h-8 text-sm'
            };

            return (
                <div 
                    className={`rounded-full flex items-center justify-center font-bold text-white flex-shrink-0 ${sizeClasses[size]}`}
                    style={{ backgroundColor: generateAvatarColor(name) }}
                >
                    {getInitials(name)}
                </div>
            );
        }

        function formatTimeAgo(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);

            if (seconds < 60) return `${seconds}s ago`;
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }

        function ActivityFeed({ history }) {
            return (
                <ul className="space-y-4 max-h-60 overflow-y-auto pr-2 relative">
                    <div className="absolute left-[5px] top-0 h-full w-0.5 bg-slate-700/50"></div>
                    {history.map(log => (
                        <li key={log.id} className="flex items-start gap-4 text-sm relative pl-4">
                            <div className="absolute left-0 top-1 w-3 h-3 bg-slate-600 rounded-full border-2 border-slate-900"></div>
                            <div>
                                <p className="text-slate-300">{log.message}</p>
                                <p className="text-xs text-slate-500">{formatTimeAgo(log.timestamp)}</p>
                            </div>
                        </li>
                    ))}
                </ul>
            );
        }

        function PieChart({ data }) {
            const radius = 50;
            const circumference = 2 * Math.PI * radius;
            const [isMounted, setIsMounted] = useState(false);
            useEffect(() => {
                const timer = setTimeout(() => setIsMounted(true), 100);
                return () => clearTimeout(timer);
            }, []);

            let cumulativeAngle = 0;

            return (
                <svg viewBox="0 0 120 120" className="w-40 h-40 flex-shrink-0">
                    <g transform="rotate(-90 60 60)">
                        {data.map(item => {
                            const total = data.reduce((sum, i) => sum + i.amount, 0);
                            if (total === 0) return null;
                            const percent = item.amount / total;
                            const dashArray = percent * circumference;
                            
                            const rotation = cumulativeAngle;
                            cumulativeAngle += percent * 360;

                            return (
                                <circle
                                    key={item.name}
                                    cx="60"
                                    cy="60"
                                    r={radius}
                                    fill="transparent"
                                    stroke={CATEGORY_COLORS[item.name]}
                                    strokeWidth="20"
                                    strokeDasharray={circumference}
                                    strokeDashoffset={isMounted ? circumference - dashArray : circumference}
                                    style={{ 
                                        transform: `rotate(${rotation}deg)`, 
                                        transformOrigin: '50% 50%', 
                                        transition: 'stroke-dashoffset 0.8s cubic-bezier(0.5, 0, 0.5, 1)' 
                                    }}
                                />
                            );
                        })}
                    </g>
                </svg>
            );
        }

        function ChartLegend({ data }) {
            return (
                <ul className="space-y-2 flex-grow">
                    {data.map(item => (
                        <li key={item.name} className="flex items-center justify-between text-sm">
                            <div className="flex items-center gap-2">
                                <span className="block w-3 h-3 rounded-full" style={{ backgroundColor: CATEGORY_COLORS[item.name] }}></span>
                                <span className="font-semibold text-slate-300">{item.name}</span>
                            </div>
                            <span className="font-bold text-slate-200">₹{item.amount.toFixed(2)}</span>
                        </li>
                    ))}
                </ul>
            );
        }

        function TripModal({ isOpen, onClose, onTripAction, tripToEdit }) {
            const [name, setName] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [isAnimating, setIsAnimating] = useState(false);

             useEffect(() => {
                if (isOpen) {
                    if (tripToEdit) {
                        setName(tripToEdit.name);
                        setDate(tripToEdit.date || new Date().toISOString().split('T')[0]);
                    } else {
                        setName('');
                        setDate(new Date().toISOString().split('T')[0]);
                    }
                    requestAnimationFrame(() => setIsAnimating(true));
                } else {
                    setIsAnimating(false);
                }
            }, [isOpen, tripToEdit]);

            const handleClose = () => {
                setIsAnimating(false);
                setTimeout(onClose, 300);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if(name.trim()) {
                    onTripAction({ name: name.trim(), date });
                }
            };
            
            if (!isOpen && !isAnimating) return null;

            return (
                <div 
                    className={`fixed inset-0 z-50 flex items-center justify-center p-4 bg-black transition-opacity duration-300 ${isAnimating ? 'bg-opacity-70' : 'bg-opacity-0'}`}
                    onClick={handleClose}
                >
                    <div 
                        className={`glass-modal rounded-xl shadow-xl w-full max-w-md p-6 transform transition-all duration-300 ${isAnimating ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0'}`}
                        onClick={e => e.stopPropagation()}
                    >
                        <h2 className="text-2xl font-bold mb-4 text-white">{tripToEdit ? 'Edit Trip' : 'Start a New Trip'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block font-semibold mb-1 text-slate-300">Trip Name</label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="e.g., Goa Adventure, Weekend Getaway"
                                    className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-white"
                                    autoFocus
                                />
                            </div>
                             <div>
                                <label className="block font-semibold mb-1 text-slate-300">Trip Date</label>
                                <input
                                    type="date"
                                    value={date}
                                    onChange={(e) => setDate(e.target.value)}
                                    className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-white"
                                />
                            </div>
                            <div className="flex justify-end gap-4 mt-6">
                                <button type="button" onClick={handleClose} className="py-2 px-4 bg-slate-700 hover:bg-slate-600 rounded-md font-semibold transition-all active:scale-95 text-white">Cancel</button>
                                <button type="submit" className="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md font-semibold transition-all active:scale-95 shadow-lg shadow-indigo-500/30">{tripToEdit ? 'Save Changes' : 'Start Trip'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function GuestModal({ isOpen, onClose, onAddGuest, onUpdateGuest, guestToEdit, existingGuests }) {
            const [name, setName] = useState('');
            const [isAnimating, setIsAnimating] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                if (isOpen) {
                    setError('');
                    if (guestToEdit) {
                        setName(guestToEdit.name);
                    } else {
                        setName('');
                    }
                    requestAnimationFrame(() => setIsAnimating(true));
                } else {
                    setIsAnimating(false);
                }
            }, [isOpen, guestToEdit]);

            const handleClose = () => {
                setIsAnimating(false);
                setTimeout(onClose, 300);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const trimmedName = name.trim();
                if (!trimmedName) {
                    setError('Guest name cannot be empty.');
                    return;
                }

                const isDuplicate = existingGuests.some(
                    g => g.name.toLowerCase() === trimmedName.toLowerCase() && g.id !== guestToEdit?.id
                );

                if (isDuplicate) {
                    setError('This guest name already exists in the trip.');
                    return;
                }

                if (guestToEdit) {
                    onUpdateGuest(guestToEdit.id, trimmedName);
                } else {
                    onAddGuest(trimmedName);
                }
                handleClose();
            };
            
            if (!isOpen && !isAnimating) return null;

            return (
                <div 
                    className={`fixed inset-0 z-50 flex items-center justify-center p-4 bg-black transition-opacity duration-300 ${isAnimating ? 'bg-opacity-70' : 'bg-opacity-0'}`}
                    onClick={handleClose}
                >
                    <div 
                        className={`glass-modal rounded-xl shadow-xl w-full max-w-md p-6 transform transition-all duration-300 ${isAnimating ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0'}`}
                        onClick={e => e.stopPropagation()}
                    >
                        <h2 className="text-2xl font-bold mb-4 text-white">{guestToEdit ? 'Edit Guest Name' : 'Add a New Guest'}</h2>
                        <form onSubmit={handleSubmit}>
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="Enter guest's name"
                                className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-white"
                                autoFocus
                            />
                            {error && <p className="text-rose-400 text-sm mt-2">{error}</p>}
                            <div className="flex justify-end gap-4 mt-6">
                                <button type="button" onClick={handleClose} className="py-2 px-4 bg-slate-700 hover:bg-slate-600 rounded-md font-semibold transition-all active:scale-95 text-white">Cancel</button>
                                <button type="submit" className="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md font-semibold transition-all active:scale-95 shadow-lg shadow-indigo-500/30">{guestToEdit ? 'Save Changes' : 'Add Guest'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }


        function ExpenseModal({ isOpen, onClose, onAddExpense, onUpdateExpense, guests, expenseToEdit }) {
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [paidById, setPaidById] = useState('');
            const [splitWith, setSplitWith] = useState([]);
            const [category, setCategory] = useState(CATEGORIES[0]);
            const [splitType, setSplitType] = useState('equally');
            const [splitDetails, setSplitDetails] = useState({});
            const [error, setError] = useState('');
            const [isAnimating, setIsAnimating] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    setError('');
                    if(expenseToEdit) {
                        setDescription(expenseToEdit.description);
                        setAmount(expenseToEdit.amount.toString());
                        setDate(expenseToEdit.date);
                        setPaidById(expenseToEdit.paidById);
                        setSplitWith(expenseToEdit.splitWith || []);
                        setCategory(expenseToEdit.category || CATEGORIES[0]);
                        setSplitType(expenseToEdit.splitType || 'equally');
                        const details = guests.reduce((acc, g) => ({...acc, [g.id]: ''}), {});
                        if (expenseToEdit.splitDetails) {
                            Object.assign(details, expenseToEdit.splitDetails);
                        }
                        setSplitDetails(details);
                    } else {
                        const firstGuestId = guests.length > 0 ? guests[0].id : '';
                        setDescription('');
                        setAmount('');
                        setDate(new Date().toISOString().split('T')[0]);
                        setPaidById(firstGuestId);
                        setSplitWith(guests.map(g => g.id));
                        setCategory(CATEGORIES[0]);
                        setSplitType('equally');
                        setSplitDetails(guests.reduce((acc, g) => ({...acc, [g.id]: ''}), {}));
                    }
                     requestAnimationFrame(() => setIsAnimating(true));
                } else {
                     setIsAnimating(false);
                }
            }, [isOpen, guests, expenseToEdit]);

            const handleClose = () => {
                setIsAnimating(false);
                setTimeout(onClose, 300);
            };

            const handleDetailChange = (guestId, value) => {
                setSplitDetails(prev => ({ ...prev, [guestId]: value }));
            };

            const unevenSplitTotal = useMemo(() => {
                return Object.entries(splitDetails).reduce((total, [guestId, value]) => {
                    if (splitWith.includes(guestId)) {
                        return total + (parseFloat(value) || 0);
                    }
                    return total;
                }, 0);
            }, [splitDetails, splitWith]);

            const handleSubmit = (e) => {
                e.preventDefault();
                const numAmount = parseFloat(amount);
                if (!description.trim()) { setError('Description is required.'); return; }
                if (isNaN(numAmount) || numAmount <= 0) { setError('Please enter a valid positive amount.'); return; }
                if (!paidById) { setError('Please select who paid.'); return; }
                if (splitWith.length === 0) { setError('Please select at least one person to split with.'); return; }

                if (splitType === 'amounts') {
                    if (Math.abs(unevenSplitTotal - numAmount) > 0.01) {
                        setError(`The sum of amounts (₹${unevenSplitTotal.toFixed(2)}) must equal the total expense (₹${numAmount.toFixed(2)}).`);
                        return;
                    }
                } else if (splitType === 'percentages') {
                    if (Math.abs(unevenSplitTotal - 100) > 0.01) {
                        setError(`The sum of percentages (${unevenSplitTotal.toFixed(2)}%) must be 100%.`);
                        return;
                    }
                }
                
                const finalSplitDetails = Object.entries(splitDetails).reduce((acc, [guestId, value]) => {
                    if (splitWith.includes(guestId) && (value || 0) > 0) {
                        acc[guestId] = value;
                    }
                    return acc;
                }, {});

                const expenseData = { description: description.trim(), amount: numAmount, date, paidById, splitWith, category, splitType, splitDetails: finalSplitDetails };
                if (expenseToEdit) {
                    onUpdateExpense(expenseToEdit.id, expenseData);
                } else {
                    onAddExpense(expenseData);
                }
                handleClose();
            };
            
            if (!isOpen && !isAnimating) return null;

            return (
                <div 
                    className={`fixed inset-0 z-50 flex justify-center items-start p-4 bg-black overflow-y-auto transition-opacity duration-300 ${isAnimating ? 'bg-opacity-70' : 'bg-opacity-0'}`}
                    onClick={handleClose}
                >
                    <div 
                        className={`glass-modal rounded-xl shadow-xl w-full max-w-lg p-6 my-8 transform transition-all duration-300 ${isAnimating ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0'}`}
                        onClick={e => e.stopPropagation()}
                    >
                        <h2 className="text-2xl font-bold mb-6 text-white">{expenseToEdit ? 'Edit Expense' : 'Add an Expense'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block font-semibold mb-1 text-slate-300">Description</label>
                                <input type="text" value={description} onChange={e => setDescription(e.target.value)} placeholder="e.g., Dinner, Groceries" className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md text-white" />
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                   <label className="block font-semibold mb-1 text-slate-300">Amount (₹)</label>
                                   <input type="number" value={amount} onChange={e => setAmount(e.target.value)} placeholder="0.00" className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md text-white" min="0.01" step="0.01" />
                                </div>
                                 <div>
                                    <label className="block font-semibold mb-1 text-slate-300">Category</label>
                                    <select value={category} onChange={e => setCategory(e.target.value)} className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md text-white">
                                        {CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label className="block font-semibold mb-1 text-slate-300">Date</label>
                                <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md text-white" />
                            </div>
                            <div>
                                <label className="block font-semibold mb-1 text-slate-300">Paid by</label>
                                <select value={paidById} onChange={e => setPaidById(e.target.value)} className="w-full p-2 bg-slate-700/50 border border-slate-600 rounded-md text-white">
                                    <option value="" disabled>Select a person</option>
                                    {guests.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block font-semibold mb-2 text-slate-300">Split</label>
                                <div className="flex items-center gap-4 mb-3 bg-slate-700/50 rounded-lg p-1">
                                    {['equally', 'amounts', 'percentages'].map(type => (
                                        <button key={type} type="button" onClick={() => setSplitType(type)} className={`flex-1 py-1 px-2 text-sm rounded-md capitalize transition-all active:scale-95 ${splitType === type ? 'bg-cyan-500 text-white' : 'bg-transparent text-slate-300 hover:bg-slate-600'}`}>
                                            {type}
                                        </button>
                                    ))}
                                </div>
                                <div className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                    {guests.map(g => (
                                        <div key={g.id} className={`flex items-center gap-2 p-2 rounded-md transition-colors ${splitWith.includes(g.id) ? 'bg-cyan-500/20' : 'bg-slate-700/30'}`}>
                                            <input 
                                                type="checkbox" 
                                                checked={splitWith.includes(g.id)} 
                                                onChange={() => setSplitWith(prev => prev.includes(g.id) ? prev.filter(id => id !== g.id) : [...prev, g.id])}
                                                className="h-4 w-4 rounded bg-slate-600 border-slate-500 text-cyan-500 focus:ring-cyan-500" 
                                            />
                                            <Avatar name={g.name} size="sm" />
                                            <label className="flex-1 cursor-pointer text-slate-200">{g.name}</label>
                                            {splitType !== 'equally' && splitWith.includes(g.id) && (
                                                <div className="relative">
                                                    {splitType === 'amounts' && <span className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400">₹</span>}
                                                    <input 
                                                        type="number" 
                                                        value={splitDetails[g.id] || ''}
                                                        onChange={(e) => handleDetailChange(g.id, e.target.value)}
                                                        className={`w-24 p-1 border rounded-md bg-slate-800 border-slate-600 text-white ${splitType === 'amounts' ? 'pl-5' : 'pr-5'}`}
                                                        placeholder="0.00"
                                                        min="0"
                                                        step="0.01"
                                                    />
                                                    {splitType === 'percentages' && <span className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400">%</span>}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                {splitType !== 'equally' && (
                                    <div className="text-right text-sm font-semibold mt-2 pr-2 text-slate-300">
                                        Total: {unevenSplitTotal.toFixed(2)}{splitType === 'percentages' ? '%' : ''}
                                    </div>
                                )}
                            </div>
                            {error && <p className="text-rose-400 text-sm font-semibold">{error}</p>}
                            <div className="flex justify-end gap-4 pt-4">
                                <button type="button" onClick={handleClose} className="py-2 px-4 bg-slate-700 hover:bg-slate-600 rounded-md font-semibold transition-all active:scale-95 text-white">Cancel</button>
                                <button type="submit" className="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-md font-semibold transition-all active:scale-95">
                                    {expenseToEdit ? 'Save Changes' : 'Add Expense'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ConfirmationModal({ isOpen, onClose, onConfirm, title, confirmButtonText, cancelButtonText, children, isDestructive }) {
            const [isAnimating, setIsAnimating] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    requestAnimationFrame(() => setIsAnimating(true));
                } else {
                    setIsAnimating(false);
                }
            }, [isOpen]);

            const handleClose = () => {
                setIsAnimating(false);
                setTimeout(onClose, 300);
            };

             const handleConfirm = () => {
                onConfirm();
                // handleClose(); // The confirm handler now closes the modal.
            };

            if (!isOpen && !isAnimating) return null;

            return (
                <div 
                    className={`fixed inset-0 z-50 flex items-center justify-center p-4 bg-black transition-opacity duration-300 ${isAnimating ? 'bg-opacity-70' : 'bg-opacity-0'}`}
                    onClick={handleClose}
                >
                    <div 
                        className={`glass-modal rounded-xl shadow-xl w-full max-w-md p-6 transform transition-all duration-300 ${isAnimating ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0'}`}
                        onClick={e => e.stopPropagation()}
                    >
                        <h3 className="text-xl font-bold mb-4 text-white">{title}</h3>
                        <div className="text-slate-300 mb-8">{children}</div>
                        <div className="flex justify-end gap-4">
                            <button 
                                onClick={handleClose} 
                                className="py-2 px-5 bg-slate-700 hover:bg-slate-600 text-white rounded-md font-semibold transition-all active:scale-95"
                            >
                                {cancelButtonText || 'Cancel'}
                            </button>
                            <button 
                                onClick={handleConfirm} 
                                className={`py-2 px-5 text-white rounded-md font-semibold transition-all active:scale-95 ${isDestructive ? 'bg-red-600 hover:bg-red-700 shadow-lg shadow-red-500/30' : 'bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-500/30'}`}
                            >
                                {confirmButtonText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>

